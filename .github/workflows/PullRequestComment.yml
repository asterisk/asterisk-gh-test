name: PullRequestComment
run-name: "PR ${{github.event.issue.number}} : Comment by ${{ github.actor }}" 
# PR comments are reported via issue_comments
on:
  issue_comment:
    types: [created]

env:
  KEYWORD_REGEX: ${{vars.PR_COMMENT_KEYWORD_REGEX}}

jobs:
  PullRequestComment:
  # Only run if the comment was on a PR
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      keyword: ${{ steps.parse.outputs.keyword }}
      pr-sha: ${{ steps.parse.outputs.sha }}
      base-branch: ${{ steps.parse.outputs.base-branch }}
    container:
      image: ghcr.io/asterisk/asteriskci-agent-rocky8:latest
    steps:
      - name: DumpEnvironment
        uses: /asterisk/asterisk-ci-actions/DumpEnvironmentAction@main

      - name: ParseComment
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BODY: ${{ github.event.comment.body }}
        run: |
          # Find the first match in the comment
          kw=$(echo $BODY | sed -n -r -e "0,/^\s*${KEYWORD_REGEX}\s*$/s//keyword=\1/p")
          if [ x"$kw" == x ] ; then
            kw="keyword=NO_KEYWORDS"
          fi
          echo $kw >> "$GITHUB_OUTPUT"
          echo "::notice::KW: $kw"
          
          sha=sha=$(gh api /repos/${{github.repository}}/pulls/${{github.event.issue.number}} --jq '.head.sha')
          echo $sha >> "$GITHUB_OUTPUT"
          echo "::notice::SHA: $sha"
          
          base_branch=base-branch=$(gh api /repos/${{github.repository}}/pulls/${{github.event.issue.number}} --jq .base.ref)
          echo $base_branch >> "$GITHUB_OUTPUT"
          echo "::notice::BRANCH: $base_branch"
          
          exit 0
          
  UnitTests:
    needs: PullRequestComment
    if: endsWith(needs.PullRequestComment.outputs.keyword, 'check')
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/asterisk/asteriskci-agent-rocky8:latest
    steps:
      - name: Run Unit Tests
        uses: asterisk/asterisk-ci-actions/RunAsteriskUnitTests@main
        with:
          pr-number: ${{github.event.issue.number}}
          pr-sha: ${{needs.PullRequestComment.outputs.sha}}
          base-branch: ${{needs.PullRequestComment.outputs.base-branch}}
          github-token: ${{secrets.GITHUB_TOKEN}}
          unittest-command: ${{vars.UNITTEST_COMMAND}}

  GateTests:
    needs: PullRequestComment
    if: endsWith(needs.PullRequestComment.outputs.keyword, 'gate')
    strategy:
      matrix:
        group: ${{ fromJSON(vars.GATETEST_LIST) }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/asterisk/asteriskci-agent-rocky8:latest
    steps:
      - name: Run Gate Tests for group ${{ matrix.group }}
        uses: asterisk/asterisk-ci-actions/RunAsteriskGateTests@main
        with:
          pr-number: ${{github.event.issue.number}}
          pr-sha: ${{needs.PullRequestComment.outputs.sha}}
          base-branch: ${{needs.PullRequestComment.outputs.base-branch}}
          testsuite-repo: ${{ vars.TESTSUITE_REPO }}
          github-token: ${{secrets.GITHUB_TOKEN}}
          gatetest-group: ${{ matrix.group }}
          gatetest-commands: ${{ vars.GATETEST_COMMANDS }} 
