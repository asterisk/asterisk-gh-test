name: PullRequestComment
run-name: ${{ github.actor }} has added a PR comment
# PR comments are reported via issue_comments
on:
  issue_comment:
    types: [created]

env:
  KEYWORD_REGEX: ${{vars.PR_COMMENT_KEYWORD_REGEX}}

jobs:
  CheckForKeywords:
  # Only run if the comment was on a PR
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    outputs:
      keyword: ${{ steps.parse.outputs.keyword }}
      pr-sha: ${{ steps.parse.outputs.sha }}
    steps:
      - name: DumpEnvironment
        uses: /asterisk/asterisk-ci-actions/DumpEnvironmentAction@main

      - name: ParseComment
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BODY: ${{ github.event.comment.body }}
        run: |
          # Find the first match in the comment
          kw=$(echo $BODY | sed -n -r -e "0,/^\s*${KEYWORD_REGEX}\s*$/s//keyword=\1/p")
          if [ x"$kw" == x ] ; then
            kw="keyword=NO_KEYWORDS"
          fi
          echo $kw >> "$GITHUB_OUTPUT"
          echo "::notice::KW: $kw"
          
          sha=sha=$(gh api /repos/asterisk/asterisk-gh-test/pulls/${{github.event.issue.number}} --jq '.head.sha')
          echo $sha >> "$GITHUB_OUTPUT"
          echo "::notice::SHA: $sha"
          exit 0

  UnitTests:
    needs: CheckForKeywords
    if: endsWith(needs.CheckForKeywords.outputs.keyword, 'check')
    uses: ./.github/workflows/RunUnitTests.yml
    with:
      pr-number: ${{github.event.issue.number}}
      pr-sha: ${{needs.CheckForKeywords.outputs.pr-sha}}
    secrets: inherit

